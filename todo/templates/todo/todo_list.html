{% extends 'base.html' %}

{% block title %}Todo List - Advanced Todo App{% endblock %}

{% block extra_css %}
<style>
    .sortable-list {
        min-height: 100px;
    }
    
    .todo-item.dragging {
        opacity: 0.5;
        background-color: #e9ecef;
    }
    
    .drag-over {
        background-color: #f8f9fa;
        border: 2px dashed #0d6efd;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2"><i class="fas fa-tasks me-2"></i>My Todo List</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <a href="{% url 'todo_create' %}" class="btn btn-primary">
                <i class="fas fa-plus me-1"></i> New Todo
            </a>
        </div>
    </div>
</div>

<!-- Filters and Search -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="search-container">
            <div class="input-group">
                <span class="input-group-text"><i class="fas fa-search"></i></span>
                <input type="text" class="form-control" id="searchInput" placeholder="Search todos..." value="{{ search_query }}">
            </div>
            <div class="search-results"></div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="d-flex gap-2">
            <select class="form-select" id="statusFilter" onchange="filterTodos()">
                <option value="">All Statuses</option>
                <option value="pending" {% if status_filter == 'pending' %}selected{% endif %}>Pending</option>
                <option value="in_progress" {% if status_filter == 'in_progress' %}selected{% endif %}>In Progress</option>
                <option value="completed" {% if status_filter == 'completed' %}selected{% endif %}>Completed</option>
            </select>
            <select class="form-select" id="categoryFilter" onchange="filterTodos()">
                <option value="">All Categories</option>
                {% for category in categories %}
                    <option value="{{ category.id }}" {% if category_filter == category.id|stringformat:"s" %}selected{% endif %}>
                        {{ category.name }}
                    </option>
                {% endfor %}
            </select>
        </div>
    </div>
</div>

<!-- Stats Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title"><i class="fas fa-tasks text-primary"></i></h5>
                <h3 class="text-primary">{{ todos|length }}</h3>
                <p class="card-text">Total Tasks</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title"><i class="fas fa-check-circle text-success"></i></h5>
                <h3 class="text-success">{{ todos|length }}</h3>
                <p class="card-text">Completed</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title"><i class="fas fa-clock text-warning"></i></h5>
                <h3 class="text-warning">{{ todos|length }}</h3>
                <p class="card-text">Pending</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title"><i class="fas fa-exclamation-triangle text-danger"></i></h5>
                <h3 class="text-danger">{{ todos|length }}</h3>
                <p class="card-text">High Priority</p>
            </div>
        </div>
    </div>
</div>

<!-- Export/Import Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title"><i class="fas fa-file-export me-2"></i>Data Management</h5>
                <div class="row">
                    <div class="col-md-6">
                        <h6>Export Todos</h6>
                        <div class="d-flex gap-2">
                            <a href="{% url 'export_todos' %}?format=json" class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-file-code me-1"></i>Export as JSON
                            </a>
                            <a href="{% url 'export_todos' %}?format=csv" class="btn btn-outline-success btn-sm">
                                <i class="fas fa-file-csv me-1"></i>Export as CSV
                            </a>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6>Import Todos</h6>
                        <form method="post" action="{% url 'import_todos' %}" enctype="multipart/form-data" class="d-flex gap-2">
                            {% csrf_token %}
                            <input type="file" name="file" accept=".json,.csv" class="form-control form-control-sm" required>
                            <button type="submit" class="btn btn-outline-info btn-sm">
                                <i class="fas fa-file-import me-1"></i>Import
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Todo List -->
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center mb-3">
            <h3><i class="fas fa-list me-2"></i>Tasks</h3>
            <div class="dropdown">
                <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="sortDropdown" data-bs-toggle="dropdown">
                    <i class="fas fa-sort me-1"></i>Sort by
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#" onclick="sortBy('created_at')">Date Created</a></li>
                    <li><a class="dropdown-item" href="#" onclick="sortBy('due_date')">Due Date</a></li>
                    <li><a class="dropdown-item" href="#" onclick="sortBy('priority')">Priority</a></li>
                    <li><a class="dropdown-item" href="#" onclick="sortBy('status')">Status</a></li>
                </ul>
            </div>
        
        {% if todos %}
            <div class="todo-list-container sortable-list" id="todoList">
                {% for todo in todos %}
                <div class="card mb-3 todo-item priority-{{ todo.priority }}" data-status="{{ todo.status }}" data-category="{{ todo.category.id|default:'none' }}" data-todo-id="{{ todo.id }}">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <div class="form-check">
                                    <input class="form-check-input todo-checkbox" type="checkbox" value="" id="todoCheck{{ todo.id }}"
                                        data-todo-id="{{ todo.id }}"
                                        {% if todo.status == 'completed' %}checked{% endif %}>
                                    <label class="form-check-label fw-bold" for="todoCheck{{ todo.id }}">
                                        {{ todo.title }}
                                        {% if todo.category %}
                                            <span class="badge" style="background-color: {{ todo.category.color }};">{{ todo.category.name }}</span>
                                        {% endif %}
                                    </label>
                                </div>
                                <p class="card-text mt-2">{{ todo.description|default:"No description" }}</p>
                                <div class="d-flex flex-wrap gap-2 mt-2">
                                    <span class="badge bg-{% if todo.priority == 'high' %}danger{% elif todo.priority == 'medium' %}warning{% else %}success{% endif %}">
                                        <i class="fas fa-exclamation-circle me-1"></i>{{ todo.priority|title }}
                                    </span>
                                    <span class="badge bg-info">
                                        <i class="fas fa-calendar me-1"></i>
                                        {% if todo.due_date %}{{ todo.due_date|date:"M d, Y" }}{% else %}No due date{% endif %}
                                    </span>
                                    <span class="badge bg-{% if todo.status == 'completed' %}success{% elif todo.status == 'in_progress' %}primary{% else %}secondary{% endif %}">
                                        <i class="fas fa-sync-alt me-1"></i>{{ todo.status|title }}
                                    </span>
                                    {% if todo.attachments.all %}
                                        <span class="badge bg-secondary">
                                            <i class="fas fa-paperclip me-1"></i>{{ todo.attachments.count }}
                                        </span>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="todo-actions">
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                        <i class="fas fa-ellipsis-v"></i>
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item" href="{% url 'todo_update' todo.id %}"><i class="fas fa-edit me-2"></i>Edit</a></li>
                                        <li><a class="dropdown-item share-todo-btn" href="#" data-todo-id="{{ todo.id }}"><i class="fas fa-share-alt me-2"></i>Share</a></li>
                                        <li><a class="dropdown-item text-danger" href="{% url 'todo_delete' todo.id %}"><i class="fas fa-trash me-2"></i>Delete</a></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="text-center py-5">
                <i class="fas fa-clipboard-list fa-3x text-muted mb-3"></i>
                <h4 class="text-muted">No todos yet</h4>
                <p class="text-muted">Get started by creating your first todo task</p>
                <a href="{% url 'todo_create' %}" class="btn btn-primary">
                    <i class="fas fa-plus me-1"></i> Create Todo
                </a>
            </div>
        {% endif %}
    </div>
</div>

<!-- Share Modal -->
<div class="modal fade" id="shareModal" tabindex="-1" aria-labelledby="shareModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="shareModalLabel">Share Todo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="shareForm">
                    <input type="hidden" id="todoIdInput" name="todo_id">
                    <div class="mb-3">
                        <label for="usernameInput" class="form-label">Username</label>
                        <input type="text" class="form-control" id="usernameInput" name="username" required>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="canEditInput" name="can_edit">
                        <label class="form-check-label" for="canEditInput">
                            Allow editing
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitShareForm()">Share</button>
            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function() {
        // Handle todo status changes
        $('.todo-checkbox').change(function() {
            const todoId = $(this).data('todo-id');
            const isChecked = $(this).is(':checked');
            
            $.post('{% url "todo_toggle_complete" 0 %}'.replace('0', todoId), {
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            }, function(data) {
                if (data.status === 'completed') {
                    $(`#todoCheck${todoId}`).prop('checked', true);
                    $(`#todoCheck${todoId}`).closest('.todo-item').find('.badge.bg-secondary').removeClass('bg-secondary').addClass('bg-success').text('Completed');
                } else {
                    $(`#todoCheck${todoId}`).prop('checked', false);
                    $(`#todoCheck${todoId}`).closest('.todo-item').find('.badge.bg-success').removeClass('bg-success').addClass('bg-secondary').text('Pending');
                }
            }).fail(function() {
                // Revert the checkbox state if the request fails
                $(`#todoCheck${todoId}`).prop('checked', !isChecked);
                alert('Error updating todo status');
            });
        });

        // Handle share button clicks
        $('.share-todo-btn').click(function(e) {
            e.preventDefault();
            const todoId = $(this).data('todo-id');
            $('#todoIdInput').val(todoId);
            $('#shareModal').modal('show');
        });

        // Handle form submission
        $('#shareForm').submit(function(e) {
            e.preventDefault();
            submitShareForm();
        });
        
        // Drag and drop functionality
        let draggedElement = null;
        
        $('.todo-item').attr('draggable', true);
        
        $('.todo-item').on('dragstart', function(e) {
            draggedElement = this;
            $(this).addClass('dragging');
            e.originalEvent.dataTransfer.effectAllowed = 'move';
            e.originalEvent.dataTransfer.setData('text/html', this.innerHTML);
        });
        
        $('.todo-item').on('dragend', function(e) {
            $(this).removeClass('dragging');
            draggedElement = null;
        });
        
        $('.todo-item').on('dragover', function(e) {
            e.preventDefault();
            e.originalEvent.dataTransfer.dropEffect = 'move';
            return false;
        });
        
        $('.todo-item').on('dragenter', function(e) {
            $(this).addClass('drag-over');
        });
        
        $('.todo-item').on('dragleave', function(e) {
            $(this).removeClass('drag-over');
        });
        
        $('.todo-item').on('drop', function(e) {
            e.stopPropagation();
            
            if (draggedElement !== this) {
                // Swap the dragged element with the target element
                const draggedId = $(draggedElement).data('todo-id');
                const targetId = $(this).data('todo-id');
                
                // Update the UI immediately for better UX
                const draggedHtml = draggedElement.innerHTML;
                const targetHtml = this.innerHTML;
                
                draggedElement.innerHTML = targetHtml;
                this.innerHTML = draggedHtml;
                
                // Update the data attributes to match the new content
                $(draggedElement).data('todo-id', targetId);
                $(this).data('todo-id', draggedId);
                
                // In a real app, you would make an AJAX call to update the order on the server
                // updateTodoOrder(draggedId, targetId);
            }
            
            $(this).removeClass('drag-over');
            return false;
        });
    });

    function submitShareForm() {
        const todoId = $('#todoIdInput').val();
        const formData = {
            'username': $('#usernameInput').val(),
            'can_edit': $('#canEditInput').is(':checked') ? 'true' : 'false',
            'csrfmiddlewaretoken': '{{ csrf_token }}'
        };

        $.post('{% url "share_todo" 0 %}'.replace('0', todoId), formData, function(data) {
            $('#shareModal').modal('hide');
            // Show success message
            $('.alert').remove();
            const alertHtml = `
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    Todo shared successfully!
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            $('.container-fluid').prepend(alertHtml);
        }).fail(function() {
            alert('Error sharing todo');
        });
    }

    function filterTodos() {
        const status = $('#statusFilter').val();
        const category = $('#categoryFilter').val();
        
        // Build query parameters
        let url = '{% url "todo_list" %}';
        const params = [];
        
        if (status) params.push(`status=${status}`);
        if (category) params.push(`category=${category}`);
        
        if (params.length > 0) {
            url += '?' + params.join('&');
        }
        
        window.location.href = url;
    }

    function sortBy(field) {
        // This would typically make an AJAX call to sort the data
        console.log('Sorting by:', field);
    }
    
    // Function to update todo order on the server (would be implemented in a real app)
    function updateTodoOrder(movedTodoId, targetTodoId) {
        // This would be an AJAX call to update the order in the database
        // $.post('/api/update-order/', {
        //     'moved_todo_id': movedTodoId,
        //     'target_todo_id': targetTodoId,
        //     'csrfmiddlewaretoken': '{{ csrf_token }}'
        // });
    }
</script>
{% endblock %}